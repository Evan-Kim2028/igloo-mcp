# v1.9.0 Migration Guide

This guide helps you migrate from v1.8.0 to v1.9.0.

## Overview

v1.9.0 focuses on **code simplification** and **consolidation**:
- 66% code reduction (from 16,000 to ~5,500 LOC)
- Lineage module simplified by 94%
- Health tools consolidated from 5 to 2 tools

## Phase 1: Code Simplification

### Lineage Module Changes

#### What Was Removed

The following advanced lineage features have been removed in v1.9.0:

1. **Column-level lineage** (`column_parser.py` - 584 LOC)
   - Too granular for most use cases
   - Added significant complexity

2. **Cross-database lineage** (`cross_db.py` - 509 LOC)
   - Niche use case
   - Can be implemented externally if needed

3. **Impact analysis** (`impact.py` - 830 LOC)
   - May be released as optional package in future
   - Complex feature rarely used

4. **Lineage history** (`history.py` - 889 LOC)
   - Snapshot/diff functionality
   - Added significant storage overhead

5. **Transformation tracking** (`transformations.py` - ~600 LOC)
   - Overlapped with column lineage
   - Not widely used

6. **External sources** (`external.py` - ~400 LOC)
   - Never fully implemented
   - Can be added back if needed

#### What Stays

Core lineage functionality remains:
- ✅ Basic dependency graphs (table-level)
- ✅ Upstream/downstream traversal
- ✅ Graph visualization (Mermaid, DOT, text)
- ✅ Lineage builder and queries

#### Migration Path for Lineage

**Before (v1.8.0)**:
```python
from snowcli_tools.lineage import (
    LineageGraph,
    ColumnLineageExtractor,  # REMOVED
    CrossDatabaseLineageBuilder,  # REMOVED
    ImpactAnalyzer,  # REMOVED
    LineageHistoryManager,  # REMOVED
)

# Column-level lineage (REMOVED)
extractor = ColumnLineageExtractor()
column_graph = extractor.extract(sql)

# Cross-database lineage (REMOVED)
cross_db_builder = CrossDatabaseLineageBuilder()
unified_graph = cross_db_builder.build()

# Impact analysis (REMOVED)
impact = ImpactAnalyzer()
report = impact.analyze_change(object_name, change_type)

# History tracking (REMOVED)
history = LineageHistoryManager()
snapshot = history.create_snapshot()
diff = history.compare(snapshot1, snapshot2)
```

**After (v1.9.0)**:
```python
from snowcli_tools.lineage import (
    Graph,  # Simplified name
    Node,
    Edge,
    traverse_dependencies,
    format_as_mermaid,
    format_as_text,
    format_as_dot,
)

# Build basic lineage graph
from snowcli_tools.lineage import LineageBuilder

builder = LineageBuilder(catalog_dir="./data_catalogue")
result = builder.build()
graph = result.graph

# Traverse dependencies
subgraph = traverse_dependencies(
    graph,
    start="DATABASE.SCHEMA.TABLE",
    direction="both",
    depth=3,
)

# Format for visualization
mermaid_diagram = format_as_mermaid(subgraph)
print(mermaid_diagram)
```

**Backward Compatibility**:
- `LineageGraph` is aliased to `Graph` (still works)
- `LineageNode` is aliased to `Node` (still works)
- `LineageEdge` is aliased to `Edge` (still works)

### Health Tools Consolidation

#### What Changed

5 separate health tools consolidated into 2:

**Before (v1.8.0)**:
```python
# 5 separate tools
- test_connection
- health_check
- check_profile_config
- get_resource_status
- check_resource_dependencies  # REMOVED
```

**After (v1.9.0)**:
```python
# 2 consolidated tools
- health_check  # Comprehensive, with options
- test_connection  # Lightweight wrapper
```

#### Migration Path for Health Tools

**Before (v1.8.0)**:
```python
# Separate tool calls
connection_result = await test_connection()
profile_result = await check_profile_config()
resource_result = await get_resource_status()
dependencies_result = await check_resource_dependencies()  # REMOVED
```

**After (v1.9.0)**:
```python
# Single consolidated call
health_result = await health_check(
    include_cortex=True,     # NEW: Check Cortex availability
    include_profile=True,    # Replaces check_profile_config
    include_catalog=True,    # Replaces get_resource_status
)

# Returns comprehensive health status:
# {
#     "connection": {...},
#     "profile": {...},
#     "cortex": {...},  # NEW
#     "catalog": {...},
#     "overall_status": "healthy"
# }

# Lightweight connection test (unchanged API)
connection_result = await test_connection()
```

#### New Cortex Health Check

v1.9.0 adds Cortex AI availability checking:

```python
health_result = await health_check(include_cortex=True)

if health_result["cortex"]["available"]:
    print("Cortex AI services are available")
    print(f"Model: {health_result['cortex']['model']}")
else:
    print(f"Cortex unavailable: {health_result['cortex']['status']}")
```

### MCP Tool Changes

#### Removed Tools

1. **`check_resource_dependencies`**
   - Reason: Confusing API, rarely used
   - Alternative: Use `health_check` with `include_catalog=True`

2. **`check_profile_config`**
   - Reason: Consolidated into `health_check`
   - Alternative: Use `health_check(include_profile=True)`

3. **`get_resource_status`**
   - Reason: Consolidated into `health_check`
   - Alternative: Use `health_check(include_catalog=True)`

#### Updated Tools

**`health_check`** - Now comprehensive:
```python
# Before (v1.8.0)
{
    "type": "object",
    "properties": {}
}

# After (v1.9.0)
{
    "type": "object",
    "properties": {
        "include_cortex": {"type": "boolean", "default": true},
        "include_profile": {"type": "boolean", "default": true},
        "include_catalog": {"type": "boolean", "default": false},
    }
}
```

**`test_connection`** - Simplified wrapper:
- Now delegates to `health_check._test_connection()`
- API unchanged (backward compatible)
- More maintainable (less code duplication)

## Testing Your Migration

### 1. Update Imports

```python
# OLD (v1.8.0)
from snowcli_tools.lineage import (
    LineageGraph,
    ColumnLineageExtractor,  # Remove
    CrossDatabaseLineageBuilder,  # Remove
    ImpactAnalyzer,  # Remove
)

# NEW (v1.9.0)
from snowcli_tools.lineage import (
    Graph,  # or LineageGraph (alias still works)
    traverse_dependencies,
    format_as_mermaid,
)
```

### 2. Update Health Checks

```python
# OLD (v1.8.0)
connection = await test_connection()
profile = await check_profile_config()
resources = await get_resource_status()

# NEW (v1.9.0)
health = await health_check(
    include_profile=True,
    include_catalog=True,
    include_cortex=True,  # NEW
)
# Or for quick check:
connection = await test_connection()
```

### 3. Update Lineage Queries

```python
# OLD (v1.8.0)
from snowcli_tools.lineage import LineageGraph

graph = LineageGraph()
subgraph = graph.traverse(
    start="TABLE",
    direction="both",
    depth=3,
)

# NEW (v1.9.0)
from snowcli_tools.lineage import Graph, traverse_dependencies

graph = Graph()  # or LineageGraph (alias)
subgraph = traverse_dependencies(
    graph,
    start="TABLE",
    direction="both",
    depth=3,
)
```

### 4. Run Tests

```bash
# Run full test suite
uv run pytest -q

# Check for deprecation warnings
uv run pytest -W default
```

## Breaking Changes

### Hard Breaks (Require Code Changes)

1. **Column-level lineage**: No longer available
   - Impact: Code using `ColumnLineageExtractor` will break
   - Solution: Use table-level lineage instead

2. **Cross-database lineage**: No longer available
   - Impact: Code using `CrossDatabaseLineageBuilder` will break
   - Solution: Build separate graphs per database

3. **Impact analysis**: No longer available
   - Impact: Code using `ImpactAnalyzer` will break
   - Solution: Implement custom impact logic or wait for optional package

4. **Lineage history**: No longer available
   - Impact: Code using `LineageHistoryManager` will break
   - Solution: Use external versioning (git, database snapshots)

5. **MCP tool `check_resource_dependencies`**: Removed
   - Impact: Direct calls will fail
   - Solution: Use `health_check(include_catalog=True)`

### Soft Breaks (Backward Compatible)

1. **`LineageGraph` → `Graph`**: Aliased (still works)
2. **`LineageNode` → `Node`**: Aliased (still works)
3. **`LineageEdge` → `Edge`**: Aliased (still works)
4. **`test_connection`**: API unchanged (delegates internally)

## Benefits of v1.9.0

1. **66% smaller codebase**: Easier to maintain and understand
2. **Faster catalog builds**: Phase 2 adds incremental building (10-20x faster)
3. **Better health checks**: Consolidated with Cortex availability
4. **Cortex documentation**: Phase 3 adds comprehensive Cortex guides
5. **Clearer API**: Removed confusing/rarely-used features

## Getting Help

If you encounter issues migrating:

1. Check this migration guide
2. Review the [CHANGELOG.md](../CHANGELOG.md)
3. See [API documentation](./api/README.md)
4. Open an issue on GitHub

## Future Roadmap

**v1.10.0** (Planned):
- Discovery Assistant (AI-powered table profiling)
- Optional impact analysis package
- Enhanced relationship discovery

**v2.0.0** (Future):
- Potential re-introduction of column lineage (if requested)
- Advanced analytics features
- Multi-cloud support
