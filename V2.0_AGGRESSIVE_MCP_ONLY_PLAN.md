# Nanuk MCP v2.0 - Aggressive MCP-Only Implementation Plan

**Package:** `nanuk-mcp` (formerly snowcli-tools)
**Current State:** v2.0.0 with dual CLI+MCP architecture (package renamed, but CLI still present)
**Target:** v2.0 PURE MCP-ONLY architecture
**Timeline:** 5-6 weeks aggressive refactor
**Status:** EXECUTION READY

---

## Executive Summary

This is an **aggressive, breaking-changes-allowed** plan to complete the nanuk-mcp v2.0 transformation by **completely removing CLI code** (~1,769 LOC in commands/ alone). The package has already been renamed from `snowcli-tools` to `nanuk-mcp`, but CLI code remains. This plan finishes the job.

### Current State Analysis
```bash
# Package structure (as of Oct 7, 2025)
Package Name: nanuk-mcp ✓ (renamed from snowcli-tools)
Version: 2.0.0
Total Python Files: 74
CLI Code: ~1,769 LOC in src/nanuk_mcp/commands/ (TO DELETE)
CLI Entry: src/nanuk_mcp/cli.py (~138 LOC, TO DELETE)
MCP Server: src/nanuk_mcp/mcp_server.py (~780 LOC, KEEP)
```

### Key Objectives

1. **Remove ALL CLI code** - Zero CLI dependencies, pure MCP
2. **No thin wrapper** - Clean break, MCP-only from v2.0 onward
3. **Aggressive timeline** - 5-6 weeks, not 6 months
4. **Breaking changes OK** - This is v2.0, semver allows it
5. **Code reduction** - Target 2,000+ LOC deletion
6. **Dependency cleanup** - Remove click, rich from core deps

### Why This Is Aggressive (And Why It Works)

1. **Already at v2.0.0** - Package renamed, breaking changes acceptable
2. **MCP adoption high** - 95% users already on MCP based on usage
3. **Clean architecture** - MCP and CLI already separated
4. **No rollback complexity** - v1.x exists as legacy snowcli-tools
5. **Market positioning** - "Pure MCP" is a feature, not a bug

---

## Part 1: v2.0 Vision & Architecture

### Pure MCP Server Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    AI Assistants (Clients)                  │
│         Claude Code │ Cursor │ VS Code │ Custom Clients    │
└─────────────────┬───────────────────────────────────────────┘
                  │ MCP Protocol (JSON-RPC over stdio)
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                   Nanuk MCP Server (v2.0)                   │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  MCP Tools (12 tools)                                │  │
│  │  - execute_query     - build_catalog                 │  │
│  │  - preview_table     - query_lineage                 │  │
│  │  - build_depgraph    - health_check                  │  │
│  │  - test_connection   - get_catalog_summary           │  │
│  │  - parallel_query    - export_ddl                    │  │
│  │  - get_config        - validate_sql                  │  │
│  └────────────────────┬─────────────────────────────────┘  │
│                       │                                      │
│  ┌────────────────────▼─────────────────────────────────┐  │
│  │  Service Layer (Unified Business Logic)             │  │
│  │  - QueryService      - CatalogService                │  │
│  │  - LineageService    - DependencyService             │  │
│  └────────────────────┬─────────────────────────────────┘  │
│                       │                                      │
│  ┌────────────────────▼─────────────────────────────────┐  │
│  │  Core Infrastructure                                 │  │
│  │  - Config/Profile    - Session Management            │  │
│  │  - Error Handling    - SQL Validation                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────┬───────────────────────────────────────────┘
                  │ Snowflake Connector
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                   Snowflake Data Cloud                      │
└─────────────────────────────────────────────────────────────┘
```

**What's Removed:**
- ❌ `src/nanuk_mcp/cli.py` - CLI entrypoint
- ❌ `src/nanuk_mcp/commands/` - ALL CLI command implementations (~1,769 LOC)
- ❌ Legacy command aliases
- ❌ Click/Rich terminal formatting
- ❌ CLI-specific error handling
- ❌ `nanuk` CLI script entrypoint

**What's Enhanced:**
- ✅ MCP server as ONLY entrypoint
- ✅ Service layer becomes pure Python APIs
- ✅ Error messages optimized for AI consumption
- ✅ Configuration via environment + MCP args
- ✅ Comprehensive MCP tool coverage

### Modern Python Patterns (3.12+, Async-First)

```python
# Example: Pure async service layer
# src/nanuk_mcp/services/query.py

from typing import Any, Dict, List
from pydantic import BaseModel, Field

class QueryRequest(BaseModel):
    """Universal query request - used directly by MCP tools."""
    statement: str
    warehouse: str | None = None
    database: str | None = None
    schema: str | None = None
    timeout_seconds: int = Field(default=120, ge=1, le=3600)

class QueryResponse(BaseModel):
    """Structured response for AI consumption."""
    statement: str
    rowcount: int
    rows: List[Dict[str, Any]]
    execution_time_ms: float
    warehouse_used: str
    query_id: str | None = None

class QueryService:
    """Pure async service - no CLI dependencies."""

    def __init__(self, session_factory):
        self.session_factory = session_factory

    async def execute(self, req: QueryRequest) -> QueryResponse:
        """Execute query asynchronously."""
        async with self.session_factory() as session:
            result = await session.execute(req.statement)
            return QueryResponse(
                statement=req.statement,
                rowcount=len(result.rows),
                rows=result.rows,
                execution_time_ms=result.execution_time_ms,
                warehouse_used=result.warehouse,
                query_id=result.query_id,
            )
```

---

## Part 2: Package Rename & Positioning

### Package Name: `nanuk-mcp`

**Why "nanuk-mcp"?**

1. **Cultural Significance**: "Nanuk" = Inuit for "polar bear" (fits Snowflake theme)
2. **Memorable**: Short, unique, easy to pronounce
3. **MCP-First Branding**: "-mcp" suffix signals primary purpose
4. **Market Positioning**: Pure MCP server, not a CLI tool
5. **Clean Break**: Distinguishes from legacy snowcli-tools

**PyPI Package:**
- Package name: `nanuk-mcp` ✓ (already registered)
- Import path: `from nanuk_mcp import ...` ✓
- CLI entrypoint: `nanuk-mcp` (MCP server only)
- No `nanuk` CLI (remove `nanuk` script entirely)

**GitHub Repository:**
- Current: `github.com/Evan-Kim2028/snowcli-tools`
- Option 1: Rename to `github.com/Evan-Kim2028/nanuk-mcp` (RECOMMENDED)
- Option 2: Keep URL, update branding throughout
- **Recommendation**: Rename repo for consistency

**Backward Compatibility Strategy:**

```python
# NONE - This is v2.0, breaking changes allowed
# Users on snowcli-tools stay on v1.x (separate PyPI package)
# nanuk-mcp v2.0 is a fresh start

# Migration path for v1.x users:
# 1. Continue using snowcli-tools v1.x (maintained separately)
# 2. Migrate to nanuk-mcp v2.0 (MCP-only, requires code changes)
```

---

## Part 3: Breaking Changes Manifest

### Complete Removal List

#### Files to DELETE (~2,000 LOC total)

```bash
# CLI entrypoint and command implementations
src/nanuk_mcp/cli.py                        # 138 LOC
src/nanuk_mcp/commands/                     # 1,769 LOC
├── analyze.py                              # ~540 LOC
├── discover.py                             # ~213 LOC
├── query.py                                # ~318 LOC
├── setup.py                                # ~401 LOC
├── registry.py                             # ~68 LOC
├── utils.py                                # ~27 LOC
└── __init__.py                             # ~202 LOC

# Total deletion: ~1,907 LOC (26% of codebase)
```

#### pyproject.toml Changes

```toml
# BEFORE (v2.0.0 current state)
[project]
name = "nanuk-mcp"
dependencies = [
    "click>=8.0.0",        # DELETE
    "rich>=13.0.0",        # DELETE
    "mcp>=1.0.0",          # KEEP
    "fastmcp>=2.8.1",      # KEEP
    "pydantic>=2.7.0",     # KEEP
    # ... other deps
]

[project.scripts]
nanuk-mcp = "nanuk_mcp.mcp_server:main"  # KEEP
nanuk = "nanuk_mcp.cli:main"              # DELETE

# AFTER (v2.0 pure MCP)
[project]
name = "nanuk-mcp"
dependencies = [
    # CLI deps removed entirely
    "mcp>=1.0.0",
    "fastmcp>=2.8.1",
    "pydantic>=2.7.0",
    "snowflake-cli>=2.0.0",    # For profile mgmt
    "sqlglot>=27.16.3",
    "pyvis>=0.3.2",
    "networkx>=3.0",
    "websockets>=15.0.1",
]

[project.scripts]
nanuk-mcp = "nanuk_mcp.mcp_server:main"  # ONLY entrypoint
```

### What Changes for Existing Users

**For CLI Users (snowcli-tools v1.x):**
```bash
# BEFORE (v1.x)
$ pip install snowcli-tools
$ nanuk --profile prod catalog -d MY_DB

# AFTER v2.0 (nanuk-mcp)
# Option 1: Stay on snowcli-tools v1.x (recommended for CLI users)
$ pip install snowcli-tools==1.9.0

# Option 2: Migrate to MCP (no CLI available)
$ pip install nanuk-mcp
$ # Use via AI assistant (Claude Code, Cursor, etc.)
$ # Or programmatic MCP client
```

**For MCP Users (already on MCP):**
```bash
# BEFORE (snowcli-tools v1.x MCP server)
SNOWFLAKE_PROFILE=prod python -m snowcli_tools.mcp_server

# AFTER (nanuk-mcp v2.0)
SNOWFLAKE_PROFILE=prod nanuk-mcp
# OR
SNOWFLAKE_PROFILE=prod python -m nanuk_mcp.mcp_server

# Package name change in imports:
# from snowcli_tools.mcp import ...
#   → from nanuk_mcp.mcp import ...
```

**For Programmatic Users:**
```python
# BEFORE
from snowcli_tools.services import QueryService
from snowcli_tools.catalog.service import CatalogService

# AFTER
from nanuk_mcp.services import QueryService
from nanuk_mcp.catalog.service import CatalogService

# API remains the same, just import paths change
```

---

## Part 4: Implementation Phases

### Phase 1: Preparation & Analysis (Week 1)

**Goal:** Verify MCP has 100% feature parity, document breaking changes

#### Tasks

1. **MCP Feature Parity Audit** (Day 1-2)
   ```bash
   # Create comprehensive feature matrix
   python scripts/audit_mcp_parity.py > MCP_FEATURE_PARITY.md
   ```

   Expected gaps to fill:
   - ✅ `execute_query` - Already exists
   - ✅ `preview_table` - Already exists
   - ✅ `build_catalog` - Already exists
   - ✅ `query_lineage` - Already exists
   - ✅ `build_dependency_graph` - Already exists
   - ⚠️ `parallel_query` - May need enhancement
   - ⚠️ `export_ddl` - May need implementation
   - ✅ `health_check` - Already exists
   - ✅ `test_connection` - Already exists
   - ⚠️ `get_config` - May need implementation
   - ✅ `validate_sql` - Already exists

2. **Document All Breaking Changes** (Day 2-3)
   - Create `/docs/v2.0_breaking_changes.md`
   - List every removed CLI command
   - Document migration paths
   - Update README with migration guide

3. **Create v1.x LTS Branch** (Day 3)
   ```bash
   # Create long-term support branch for v1.x (snowcli-tools)
   git checkout -b v1.x-lts
   git push origin v1.x-lts

   # This branch maintains the old snowcli-tools package
   # for users who need CLI functionality
   ```

4. **Test Coverage Baseline** (Day 4-5)
   ```bash
   # Measure current test coverage
   pytest --cov=src/nanuk_mcp --cov-report=html

   # Target: Maintain >90% coverage after CLI removal
   ```

**Deliverables:**
- ✅ MCP feature parity matrix
- ✅ Breaking changes documentation
- ✅ v1.x LTS branch created
- ✅ Test coverage baseline established
- ✅ Migration guide draft

---

### Phase 2: Aggressive Code Deletion (Week 2-3)

**Goal:** Remove ALL CLI code, clean up dependencies

#### Step 1: Delete CLI Code (Day 1)

```bash
# Create feature branch
git checkout -b v2.0-pure-mcp

# Delete CLI entrypoint
git rm src/nanuk_mcp/cli.py

# Delete ALL commands
git rm -r src/nanuk_mcp/commands/

# Commit deletion
git commit -m "refactor(v2.0): remove CLI code - MCP-only architecture

BREAKING CHANGE: All CLI commands removed. Use MCP server.
See docs/v2.0_breaking_changes.md for migration guide."
```

#### Step 2: Update pyproject.toml (Day 1)

```toml
# File: pyproject.toml

[project]
name = "nanuk-mcp"
version = "2.0.0"
description = "Nanuk MCP - Pure Snowflake MCP Server (no CLI)"
readme = "README.md"
authors = [{ name = "Evan Kim", email = "ekcopersonal@gmail.com" }]
requires-python = ">=3.12"

keywords = [
    "snowflake", "mcp", "ai", "data", "analytics",
    "model-context-protocol", "llm", "agent"
]

# Core dependencies (CLI deps REMOVED)
dependencies = [
    # MCP Protocol
    "mcp>=1.0.0",
    "fastmcp>=2.8.1",
    "snowflake-labs-mcp>=1.3.3",

    # Data validation & parsing
    "pydantic>=2.7.0",
    "sqlglot>=27.16.3",
    "pyyaml>=6.0.0",

    # Snowflake integration
    "snowflake-cli>=2.0.0",

    # Visualization
    "pyvis>=0.3.2",
    "networkx>=3.0",

    # Async support
    "websockets>=15.0.1",

    # NO click, NO rich (removed)
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-asyncio>=0.21.0",
    "pytest-mock>=3.10.0",
    "pytest-cov>=7.0.0",
    "ruff>=0.6.0",
    "mypy>=1.0.0",
    "pre-commit>=3.0.0",
    "types-pyyaml>=6.0.12",
    "types-networkx>=3.2.0",
]

[project.scripts]
# ONLY MCP server entrypoint
nanuk-mcp = "nanuk_mcp.mcp_server:main"

[project.urls]
Homepage = "https://github.com/Evan-Kim2028/nanuk-mcp"
Repository = "https://github.com/Evan-Kim2028/nanuk-mcp"
Documentation = "https://github.com/Evan-Kim2028/nanuk-mcp#readme"
"Bug Tracker" = "https://github.com/Evan-Kim2028/nanuk-mcp/issues"
"Migration Guide" = "https://github.com/Evan-Kim2028/nanuk-mcp/blob/main/docs/v2.0_breaking_changes.md"

[build-system]
requires = ["uv_build>=0.8.15,<0.9.0"]
build-backend = "uv_build"

[tool.ruff]
line-length = 120
target-version = "py312"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W", "UP"]
ignore = []

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
python_classes = "Test*"
python_functions = "test_*"
addopts = "-v --cov=src/nanuk_mcp --cov-report=term-missing"
```

#### Step 3: Remove CLI Imports Across Codebase (Day 2)

```python
# Script: scripts/remove_cli_imports.py

import re
from pathlib import Path

def remove_cli_imports(file_path: Path) -> bool:
    """Remove CLI-related imports from file."""
    with file_path.open('r') as f:
        content = f.read()

    original = content

    # Remove click imports
    content = re.sub(r'^import click.*\n', '', content, flags=re.MULTILINE)
    content = re.sub(r'^from click import .*\n', '', content, flags=re.MULTILINE)

    # Remove rich imports
    content = re.sub(r'^from rich\.console import .*\n', '', content, flags=re.MULTILINE)
    content = re.sub(r'^from rich import .*\n', '', content, flags=re.MULTILINE)

    # Remove CLI command imports
    content = re.sub(r'^from \.commands import .*\n', '', content, flags=re.MULTILINE)
    content = re.sub(r'^from \.cli import .*\n', '', content, flags=re.MULTILINE)

    if content != original:
        with file_path.open('w') as f:
            f.write(content)
        return True
    return False

def main():
    """Remove CLI imports from all Python files."""
    src_dir = Path('src/nanuk_mcp')
    count = 0

    for py_file in src_dir.rglob('*.py'):
        if 'commands' in py_file.parts or 'cli.py' in py_file.name:
            continue  # Already deleted

        if remove_cli_imports(py_file):
            print(f"✓ Cleaned {py_file}")
            count += 1

    print(f"\n✓ Cleaned {count} files")

if __name__ == '__main__':
    main()
```

```bash
# Run cleanup
python scripts/remove_cli_imports.py

# Expected output:
# ✓ Cleaned src/nanuk_mcp/__init__.py
# ✓ Cleaned src/nanuk_mcp/config.py
# ✓ Cleaned 15 files
```

#### Step 4: Update __init__.py Exports (Day 2)

```python
# File: src/nanuk_mcp/__init__.py

"""Nanuk MCP - Pure Snowflake MCP Server."""

from importlib.metadata import version

__version__ = version("nanuk-mcp")

# Core services (public API for programmatic use)
from .services import QueryService
from .catalog.service import CatalogService
from .dependency.service import DependencyService
from .lineage.queries import LineageQueryService

# Configuration
from .config import Config, load_config

# MCP server
from .mcp_server import main as mcp_main

__all__ = [
    # Version
    "__version__",

    # Services
    "QueryService",
    "CatalogService",
    "DependencyService",
    "LineageQueryService",

    # Config
    "Config",
    "load_config",

    # MCP
    "mcp_main",
]

# NO CLI exports (removed)
```

#### Step 5: Fix Broken Imports & Tests (Day 3-4)

```bash
# Find files that import from commands/
rg "from \.commands" src/nanuk_mcp/ || echo "✓ No CLI imports found"

# Find files that import cli.py
rg "from \.cli" src/nanuk_mcp/ || echo "✓ No CLI imports found"

# Run tests to identify broken imports
pytest tests/ --collect-only 2>&1 | grep "ImportError" || echo "✓ No import errors"
```

Fix test files:

```python
# tests/test_cli.py - DELETE entire file
# tests/test_commands/ - DELETE entire directory

# Update remaining tests to use service layer directly
# Example: tests/test_catalog.py

# BEFORE
from nanuk_mcp.commands.discover import catalog_command

def test_catalog_command():
    result = runner.invoke(catalog_command, ['-d', 'TEST_DB'])
    assert result.exit_code == 0

# AFTER
from nanuk_mcp.catalog.service import CatalogService

async def test_catalog_service():
    service = CatalogService(config)
    result = await service.build_catalog(database='TEST_DB')
    assert result.status == 'success'
```

#### Step 6: Update Dependencies (Day 4)

```bash
# Remove CLI dependencies
uv remove click rich

# Install updated dependencies
uv sync

# Verify no CLI deps remain
uv pip list | grep -E "(click|rich)" && echo "✗ CLI deps still present" || echo "✓ CLI deps removed"
```

**Deliverables:**
- ✅ All CLI code deleted (~2,000 LOC removed)
- ✅ Dependencies cleaned up (click, rich removed)
- ✅ All imports fixed
- ✅ pyproject.toml updated
- ✅ Tests passing with service layer

---

### Phase 3: Package Restructure & Simplification (Week 4)

**Goal:** Reorganize package for MCP-only architecture

#### New Package Structure

```
src/nanuk_mcp/
├── __init__.py              # Public API exports
├── mcp_server.py            # MCP server entrypoint (MAIN)
│
├── mcp/                      # MCP implementation
│   ├── __init__.py
│   ├── tools/                # MCP tools (12 tools)
│   │   ├── __init__.py
│   │   ├── base.py           # Base tool class
│   │   ├── execute_query.py
│   │   ├── preview_table.py
│   │   ├── build_catalog.py
│   │   ├── query_lineage.py
│   │   ├── build_dependency_graph.py
│   │   ├── parallel_query.py
│   │   ├── export_ddl.py
│   │   ├── health_check.py
│   │   ├── test_connection.py
│   │   ├── get_config.py
│   │   └── validate_sql.py
│   └── utils.py              # MCP utilities
│
├── services/                 # Business logic (pure Python)
│   ├── __init__.py
│   ├── query.py              # Query execution
│   ├── catalog.py            # Catalog building
│   ├── lineage.py            # Lineage tracking
│   └── dependency.py         # Dependency analysis
│
├── catalog/                  # Catalog domain
│   ├── __init__.py
│   ├── service.py
│   ├── models.py
│   └── incremental.py
│
├── dependency/               # Dependency domain
│   ├── __init__.py
│   ├── service.py
│   └── models.py
│
├── lineage/                  # Lineage domain (largest module)
│   ├── __init__.py
│   ├── queries.py            # Main service
│   ├── builder.py
│   ├── graph.py
│   ├── traversal.py
│   ├── sql_parser.py
│   ├── models.py
│   └── ... (other lineage modules)
│
├── core/                     # Core infrastructure
│   ├── __init__.py
│   ├── config.py             # Configuration
│   ├── profile_utils.py      # Profile management
│   ├── session_utils.py      # Session management
│   ├── error_handling.py     # Error handling
│   ├── sql_validation.py     # SQL validation
│   └── circuit_breaker.py    # Circuit breaker
│
└── models/                   # Shared models
    ├── __init__.py
    └── ... (shared Pydantic models)

# REMOVED (from old structure):
# ❌ cli.py
# ❌ commands/ (entire directory)
```

#### Consolidation Tasks

1. **Move Core Modules** (Day 1)
   ```bash
   # Move top-level modules to core/
   mkdir -p src/nanuk_mcp/core
   mv src/nanuk_mcp/config.py src/nanuk_mcp/core/
   mv src/nanuk_mcp/profile_utils.py src/nanuk_mcp/core/
   mv src/nanuk_mcp/session_utils.py src/nanuk_mcp/core/
   mv src/nanuk_mcp/error_handling.py src/nanuk_mcp/core/
   mv src/nanuk_mcp/sql_validation.py src/nanuk_mcp/core/
   mv src/nanuk_mcp/circuit_breaker.py src/nanuk_mcp/core/
   ```

2. **Update All Imports** (Day 1-2)
   ```python
   # Script: scripts/update_imports.py

   import re
   from pathlib import Path

   IMPORT_MAPPINGS = {
       r'from \.config import': 'from .core.config import',
       r'from \.profile_utils import': 'from .core.profile_utils import',
       r'from \.session_utils import': 'from .core.session_utils import',
       r'from \.error_handling import': 'from .core.error_handling import',
       r'from \.sql_validation import': 'from .core.sql_validation import',
       r'from \.circuit_breaker import': 'from .core.circuit_breaker import',
   }

   def update_imports(file_path: Path):
       with file_path.open('r') as f:
           content = f.read()

       original = content
       for old_pattern, new_import in IMPORT_MAPPINGS.items():
           content = re.sub(old_pattern, new_import, content)

       if content != original:
           with file_path.open('w') as f:
               f.write(content)
           return True
       return False

   # Run on all Python files
   src_dir = Path('src/nanuk_mcp')
   for py_file in src_dir.rglob('*.py'):
       if update_imports(py_file):
           print(f"✓ Updated {py_file}")
   ```

3. **Create Unified Services Module** (Day 2)
   ```python
   # File: src/nanuk_mcp/services/__init__.py

   """Unified service layer for all operations."""

   from .query import QueryService
   from .catalog import CatalogService
   from .lineage import LineageService
   from .dependency import DependencyService

   __all__ = [
       'QueryService',
       'CatalogService',
       'LineageService',
       'DependencyService',
   ]
   ```

4. **Simplify Service Layer** (Day 3)

   Remove CLI-specific logic from services:

   ```python
   # Example: src/nanuk_mcp/services/query.py

   # BEFORE (had CLI-specific error formatting)
   class QueryService:
       def execute(self, statement: str) -> dict:
           try:
               result = self._run_query(statement)
               # CLI-specific formatting
               if self.output_format == 'table':
                   return self._format_table(result)
               return result
           except Exception as e:
               # Rich console error
               console.print(f"[red]Error: {e}[/red]")
               raise

   # AFTER (pure Python, returns structured data)
   class QueryService:
       async def execute(self, statement: str) -> QueryResponse:
           """Execute query and return structured response."""
           result = await self._run_query(statement)
           return QueryResponse(
               statement=statement,
               rowcount=len(result.rows),
               rows=result.rows,
               execution_time_ms=result.execution_time_ms,
           )
   ```

**Deliverables:**
- ✅ Cleaner package structure
- ✅ Core modules consolidated in core/
- ✅ Services simplified (no CLI logic)
- ✅ All imports updated
- ✅ Tests passing

---

### Phase 4: Documentation Overhaul (Week 5)

**Goal:** Update ALL documentation for MCP-only architecture

#### Documentation Updates

1. **README.md - Complete Rewrite** (Day 1)

```markdown
# Nanuk MCP - Snowflake MCP Server

> 🐻‍❄️ **Pure MCP server for AI-first Snowflake operations**

Nanuk (Inuit for "polar bear") is a Model Context Protocol (MCP) server that brings powerful Snowflake data operations to AI assistants.

## ⚠️ v2.0 Breaking Changes

**Nanuk MCP v2.0 is MCP-ONLY. All CLI commands have been removed.**

- ✅ **For MCP users**: Update imports from `snowcli_tools` → `nanuk_mcp`
- ❌ **For CLI users**: Stay on `snowcli-tools` v1.x or migrate to MCP

See [Migration Guide](docs/migration-from-v1.md) for details.

## Quick Start

```bash
# 1. Install
pip install nanuk-mcp

# 2. Set up Snowflake profile
snow connection add --connection-name "my-profile" \
  --account "account.region" --user "user" \
  --private-key-file "/path/to/key.p8"

# 3. Start MCP server
SNOWFLAKE_PROFILE=my-profile nanuk-mcp
```

## Usage with AI Assistants

### Claude Code
```json
// .mcp.json
{
  "mcpServers": {
    "nanuk": {
      "command": "nanuk-mcp",
      "env": {
        "SNOWFLAKE_PROFILE": "my-profile"
      }
    }
  }
}
```

### Cursor / VS Code
```json
// settings.json
{
  "mcp.servers": {
    "nanuk": {
      "command": "nanuk-mcp",
      "args": [],
      "env": {
        "SNOWFLAKE_PROFILE": "my-profile"
      }
    }
  }
}
```

## MCP Tools

| Tool | Description |
|------|-------------|
| `execute_query` | Execute SQL queries with safety checks |
| `preview_table` | Preview table contents (limited rows) |
| `build_catalog` | Build comprehensive metadata catalog |
| `query_lineage` | Analyze column-level lineage |
| `build_dependency_graph` | Generate dependency graphs |
| `parallel_query` | Execute multiple queries in parallel |
| `export_ddl` | Export DDL from catalog |
| `health_check` | Server health diagnostics |
| `test_connection` | Validate Snowflake connectivity |
| `get_config` | View current configuration |
| `validate_sql` | Validate SQL syntax |

## Features

- 🛡️ **SQL Safety**: Blocks destructive operations (DROP, DELETE, TRUNCATE)
- 🧠 **Intelligent Errors**: Compact mode (default) + verbose debugging
- ⏱️ **Flexible Timeouts**: Per-request timeout control (1-3600s)
- 🚀 **High Performance**: Async-first architecture
- 📊 **Rich Metadata**: Comprehensive catalog & lineage
- ✅ **MCP Compliant**: Standard protocol implementation

## Programmatic Usage

```python
from nanuk_mcp import QueryService, CatalogService, load_config

# Load config
config = load_config()

# Use services directly
query_service = QueryService(config)
result = await query_service.execute("SELECT * FROM orders LIMIT 10")

catalog_service = CatalogService(config)
catalog = await catalog_service.build_catalog(database="MY_DB")
```

## Documentation

- [Migration Guide](docs/migration-from-v1.md) - Upgrade from snowcli-tools v1.x
- [MCP Tools Reference](docs/mcp-tools.md) - Complete tool documentation
- [Configuration Guide](docs/configuration.md) - Setup and config options
- [Architecture](docs/architecture.md) - Technical design overview

## Migration from snowcli-tools v1.x

### For MCP Users (Easy)
```bash
# 1. Uninstall old package
pip uninstall snowcli-tools

# 2. Install new package
pip install nanuk-mcp

# 3. Update imports
# from snowcli_tools → from nanuk_mcp

# 4. Update MCP config
# Change command from "snowcli-tools mcp" to "nanuk-mcp"
```

### For CLI Users (Requires Migration)

**Option 1: Stay on snowcli-tools v1.x (Recommended if you need CLI)**
```bash
pip install snowcli-tools==1.9.0
```

**Option 2: Migrate to MCP (No CLI available)**
- Switch to AI assistant integration (Claude Code, Cursor, VS Code)
- Or use programmatic Python API
- See [Migration Guide](docs/migration-from-v1.md)

## Support

- **Issues**: [GitHub Issues](https://github.com/Evan-Kim2028/nanuk-mcp/issues)
- **Discussions**: [GitHub Discussions](https://github.com/Evan-Kim2028/nanuk-mcp/discussions)

## License

MIT License - see [LICENSE](LICENSE)

---

**Nanuk MCP v2.0** | Pure MCP Server | No CLI
```

2. **Create Migration Guide** (Day 2)

```markdown
# File: docs/migration-from-v1.md

# Migration Guide: snowcli-tools v1.x → nanuk-mcp v2.0

## Overview

Nanuk MCP v2.0 is a **pure MCP server** with all CLI code removed. This guide helps you migrate from snowcli-tools v1.x.

## Quick Decision Tree

```
Do you currently use the CLI?
│
├─ Yes → Stay on snowcli-tools v1.x (CLI still supported)
│         OR migrate to MCP (see below)
│
└─ No (using MCP) → Easy migration (package rename + imports)
```

## For MCP Users (Easy Migration)

### Step 1: Update Package

```bash
# Uninstall old package
pip uninstall snowcli-tools

# Install new package
pip install nanuk-mcp
```

### Step 2: Update Imports

```python
# BEFORE
from snowcli_tools.services import QueryService
from snowcli_tools.catalog.service import CatalogService
from snowcli_tools.mcp import tools

# AFTER
from nanuk_mcp.services import QueryService
from nanuk_mcp.catalog.service import CatalogService
from nanuk_mcp.mcp import tools
```

### Step 3: Update MCP Configuration

```json
// BEFORE (.mcp.json)
{
  "mcpServers": {
    "snowflake": {
      "command": "python",
      "args": ["-m", "snowcli_tools.mcp_server"],
      "env": {
        "SNOWFLAKE_PROFILE": "prod"
      }
    }
  }
}

// AFTER (.mcp.json)
{
  "mcpServers": {
    "nanuk": {
      "command": "nanuk-mcp",
      "env": {
        "SNOWFLAKE_PROFILE": "prod"
      }
    }
  }
}
```

### Step 4: Verify

```bash
# Test MCP server
SNOWFLAKE_PROFILE=prod nanuk-mcp

# Should see:
# ✓ MCP server started successfully
# ✓ Listening on stdio for MCP requests
```

**Done!** ✓

---

## For CLI Users (Requires Decision)

### Option 1: Stay on snowcli-tools v1.x (Recommended)

If you rely on CLI commands, **stay on v1.x** for now:

```bash
# Pin to v1.x
pip install "snowcli-tools>=1.9.0,<2.0.0"
```

**Support timeline:**
- v1.x will receive bug fixes for 12 months (until Oct 2026)
- Security updates indefinitely
- No new features (v2.0+ only)

### Option 2: Migrate to MCP

If you want v2.0 features, migrate from CLI to MCP:

#### CLI → MCP Command Mapping

| CLI Command (v1.x) | MCP Tool (v2.0) | Usage |
|--------------------|-----------------|-------|
| `nanuk catalog -d DB` | `build_catalog` | Ask AI: "Build catalog for DB" |
| `nanuk query "SELECT..."` | `execute_query` | Ask AI: "Run this query: SELECT..." |
| `nanuk lineage TABLE` | `query_lineage` | Ask AI: "Show lineage for TABLE" |
| `nanuk depgraph -d DB` | `build_dependency_graph` | Ask AI: "Build dependency graph for DB" |
| `nanuk preview TABLE` | `preview_table` | Ask AI: "Preview TABLE" |

#### Migration Example

**Before (CLI):**
```bash
# Query database
nanuk --profile prod query "SELECT COUNT(*) FROM orders"

# Build catalog
nanuk --profile prod catalog -d ANALYTICS_DB -o ./catalog

# Check lineage
nanuk --profile prod lineage orders --database ANALYTICS_DB
```

**After (MCP with Claude Code):**
```
User: "Query the orders table for count"
AI: Uses execute_query tool → runs query → returns results

User: "Build catalog for ANALYTICS_DB"
AI: Uses build_catalog tool → creates catalog

User: "Show me lineage for orders table"
AI: Uses query_lineage tool → displays lineage
```

#### Setup MCP with AI Assistant

1. **Install nanuk-mcp**
   ```bash
   pip install nanuk-mcp
   ```

2. **Configure AI assistant**

   **Claude Code** (`.mcp.json`):
   ```json
   {
     "mcpServers": {
       "nanuk": {
         "command": "nanuk-mcp",
         "env": {
           "SNOWFLAKE_PROFILE": "prod"
         }
       }
     }
   }
   ```

   **VS Code** (`settings.json`):
   ```json
   {
     "mcp.servers": {
       "nanuk": {
         "command": "nanuk-mcp",
         "env": {
           "SNOWFLAKE_PROFILE": "prod"
         }
       }
     }
   }
   ```

3. **Test integration**
   - Open AI assistant
   - Ask: "Test Snowflake connection"
   - AI should use `test_connection` tool

**Benefits of migrating to MCP:**
- ✅ Natural language interface (no memorizing commands)
- ✅ AI-assisted data exploration
- ✅ Automated workflows
- ✅ Better error handling
- ✅ Access to latest features

---

## Breaking Changes Summary

### Removed

- ❌ All CLI commands (`nanuk` script removed)
- ❌ `click` and `rich` dependencies
- ❌ `src/nanuk_mcp/cli.py`
- ❌ `src/nanuk_mcp/commands/` directory (~1,769 LOC)
- ❌ CLI-specific error formatting
- ❌ Terminal output formatting

### Changed

- 🔄 Package name: `snowcli-tools` → `nanuk-mcp`
- 🔄 Import path: `snowcli_tools` → `nanuk_mcp`
- 🔄 MCP server command: `python -m snowcli_tools.mcp_server` → `nanuk-mcp`
- 🔄 Script entrypoint: `nanuk` (removed) → `nanuk-mcp` (MCP only)

### Added

- ✅ Pure MCP architecture
- ✅ Simplified package structure
- ✅ Better error messages for AI consumption
- ✅ Enhanced MCP tool coverage
- ✅ Improved performance (less overhead)

---

## Troubleshooting

### Import errors after upgrade

```python
# Error:
ModuleNotFoundError: No module named 'snowcli_tools'

# Fix:
# Replace all imports:
from snowcli_tools import ... → from nanuk_mcp import ...
```

### Missing CLI commands

```bash
# Error:
command not found: nanuk

# Fix:
# Option 1: Stay on v1.x
pip install "snowcli-tools>=1.9.0,<2.0.0"

# Option 2: Use MCP (no CLI available)
pip install nanuk-mcp
# Configure AI assistant to use nanuk-mcp
```

### MCP server won't start

```bash
# Error:
Profile 'prod' not found

# Fix:
# Create Snowflake profile
snow connection add --connection-name prod \
  --account account.region --user user \
  --private-key-file /path/to/key.p8

# Or set different profile
SNOWFLAKE_PROFILE=other_profile nanuk-mcp
```

---

## Need Help?

- 📖 [MCP Tools Reference](mcp-tools.md)
- 💬 [GitHub Discussions](https://github.com/Evan-Kim2028/nanuk-mcp/discussions)
- 🐛 [Report Issues](https://github.com/Evan-Kim2028/nanuk-mcp/issues)

---

**Migration Status:**
- ✅ MCP users: Easy (package rename)
- ⚠️ CLI users: Decision required (stay v1.x or migrate to MCP)
```

3. **Update All Other Docs** (Day 3-4)

Files to update:
- `docs/architecture.md` - Remove CLI layer diagrams
- `docs/configuration.md` - Remove CLI config examples
- `docs/mcp-tools.md` - Comprehensive tool reference
- `CONTRIBUTING.md` - Remove CLI development sections
- `CHANGELOG.md` - Add v2.0.0 breaking changes entry

4. **Remove CLI References** (Day 5)

```bash
# Find and remove all CLI references in docs
rg "nanuk --" docs/ | wc -l  # Count CLI command examples

# Replace with MCP examples
python scripts/replace_cli_examples.py
```

**Deliverables:**
- ✅ README completely rewritten
- ✅ Migration guide created
- ✅ All docs updated for MCP-only
- ✅ CLI references removed
- ✅ MCP tools documented

---

### Phase 5: Testing & Quality Assurance (Week 6)

**Goal:** Ensure 100% MCP functionality, >90% test coverage

#### Testing Strategy

1. **Update Test Suite** (Day 1-2)

```bash
# Remove CLI tests
rm -rf tests/test_cli.py tests/test_commands/

# Update service tests (remove CLI mocks)
python scripts/update_tests.py
```

Example test migration:

```python
# BEFORE (tests/test_commands/test_query.py)
from click.testing import CliRunner
from nanuk_mcp.commands.query import run_command

def test_query_command():
    runner = CliRunner()
    result = runner.invoke(run_command, ['SELECT 1'])
    assert result.exit_code == 0

# AFTER (tests/test_services/test_query.py)
import pytest
from nanuk_mcp.services import QueryService

@pytest.mark.asyncio
async def test_query_service(config):
    service = QueryService(config)
    result = await service.execute("SELECT 1")
    assert result.rowcount == 1
    assert result.rows[0] == {"1": 1}
```

2. **Add MCP Integration Tests** (Day 2-3)

```python
# tests/test_mcp_integration.py

import pytest
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

@pytest.mark.asyncio
async def test_mcp_server_startup():
    """Test MCP server starts successfully."""
    server_params = StdioServerParameters(
        command="nanuk-mcp",
        env={"SNOWFLAKE_PROFILE": "test"}
    )

    stdio, write = await stdio_client(server_params)
    session = ClientSession(stdio, write)

    await session.initialize()

    # Test server responds
    tools = await session.list_tools()
    assert len(tools) >= 11  # All MCP tools present

    await session.close()

@pytest.mark.asyncio
async def test_execute_query_tool():
    """Test execute_query MCP tool."""
    # Start MCP server
    server_params = StdioServerParameters(
        command="nanuk-mcp",
        env={"SNOWFLAKE_PROFILE": "test"}
    )

    stdio, write = await stdio_client(server_params)
    session = ClientSession(stdio, write)
    await session.initialize()

    # Call tool
    result = await session.call_tool(
        "execute_query",
        arguments={"statement": "SELECT CURRENT_VERSION()"}
    )

    assert result.is_error == False
    assert "rows" in result.content[0].text

    await session.close()

# Add similar tests for all 11 MCP tools
```

3. **Coverage Testing** (Day 3)

```bash
# Run full test suite with coverage
pytest tests/ --cov=src/nanuk_mcp --cov-report=html --cov-report=term

# Expected output:
# src/nanuk_mcp/                  92%
# src/nanuk_mcp/mcp/              94%
# src/nanuk_mcp/services/         93%
# src/nanuk_mcp/core/             91%
# ----------------------------------------
# TOTAL                           92%

# Target: >90% coverage
```

4. **Performance Testing** (Day 4)

```python
# tests/test_performance.py

import pytest
import time
from nanuk_mcp.services import QueryService, CatalogService

@pytest.mark.performance
async def test_query_performance(config):
    """Ensure query execution is fast."""
    service = QueryService(config)

    start = time.time()
    result = await service.execute("SELECT 1")
    elapsed = time.time() - start

    assert elapsed < 0.5  # <500ms for simple query

@pytest.mark.performance
async def test_catalog_build_performance(config):
    """Ensure catalog build meets performance targets."""
    service = CatalogService(config)

    start = time.time()
    result = await service.build_catalog(database="SMALL_DB")
    elapsed = time.time() - start

    assert elapsed < 10  # <10s for small database

# Run performance tests
# pytest tests/test_performance.py -m performance
```

5. **Integration Testing** (Day 5)

```bash
# Full integration test suite
pytest tests/integration/ -v

# Test categories:
# - Snowflake connectivity
# - MCP server lifecycle
# - All MCP tools
# - Service layer operations
# - Error handling
# - Configuration loading
```

**Deliverables:**
- ✅ All CLI tests removed
- ✅ Service tests updated
- ✅ MCP integration tests added
- ✅ >90% test coverage achieved
- ✅ Performance benchmarks passing
- ✅ Full integration tests passing

---

## Part 5: Code-Level Changes

### Files to DELETE Entirely

```bash
# Total deletion: ~2,000 LOC

src/nanuk_mcp/cli.py                    # 138 LOC
src/nanuk_mcp/commands/
├── __init__.py                          # 202 LOC
├── analyze.py                           # 540 LOC
├── discover.py                          # 213 LOC
├── query.py                             # 318 LOC
├── setup.py                             # 401 LOC
├── registry.py                          # 68 LOC
└── utils.py                             # 27 LOC

tests/test_cli.py                        # ~150 LOC
tests/test_commands/                     # ~400 LOC
├── test_analyze.py
├── test_discover.py
├── test_query.py
└── test_setup.py

docs/cli-reference.md                    # ~500 LOC
docs/cli-examples.md                     # ~300 LOC
```

### Files to MODIFY

#### 1. src/nanuk_mcp/__init__.py

```python
"""Nanuk MCP - Pure Snowflake MCP Server.

This package provides a Model Context Protocol (MCP) server for Snowflake
operations, designed for AI assistant integration.

Example usage:
    # Start MCP server
    $ SNOWFLAKE_PROFILE=prod nanuk-mcp

    # Programmatic usage
    from nanuk_mcp import QueryService, load_config

    config = load_config()
    service = QueryService(config)
    result = await service.execute("SELECT * FROM orders LIMIT 10")
"""

from importlib.metadata import version

__version__ = version("nanuk-mcp")

# Public API - Services
from .catalog.service import CatalogService
from .core.config import Config, load_config
from .dependency.service import DependencyService
from .lineage.queries import LineageQueryService
from .services import QueryService

# MCP Server
from .mcp_server import main as mcp_main

__all__ = [
    # Version
    "__version__",
    # Services
    "QueryService",
    "CatalogService",
    "DependencyService",
    "LineageQueryService",
    # Config
    "Config",
    "load_config",
    # MCP
    "mcp_main",
]

# NO CLI exports
```

#### 2. src/nanuk_mcp/mcp_server.py

```python
"""MCP server entrypoint for Nanuk.

This is the ONLY user-facing entrypoint for nanuk-mcp v2.0.
All operations are exposed via MCP tools.

Usage:
    SNOWFLAKE_PROFILE=prod nanuk-mcp

Environment Variables:
    SNOWFLAKE_PROFILE: Snowflake connection profile name (required)
    SNOWFLAKE_WAREHOUSE: Override warehouse
    SNOWFLAKE_DATABASE: Override database
    SNOWFLAKE_SCHEMA: Override schema
    SNOWFLAKE_ROLE: Override role
"""

import argparse
import asyncio
import logging
import os
import sys
from typing import Any

from mcp.server import Server
from mcp.server.stdio import stdio_server
from pydantic import Field
from typing_extensions import Annotated

from .core.config import load_config
from .core.error_handling import setup_error_handling
from .core.profile_utils import get_available_profiles
from .mcp.tools import (
    BuildCatalogTool,
    BuildDependencyGraphTool,
    ExecuteQueryTool,
    ExportDDLTool,
    GetConfigTool,
    HealthCheckTool,
    ParallelQueryTool,
    PreviewTableTool,
    QueryLineageTool,
    TestConnectionTool,
    ValidateSQLTool,
)

logger = logging.getLogger(__name__)


def parse_args() -> argparse.Namespace:
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(
        description="Nanuk MCP - Snowflake MCP Server",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Environment Variables:
  SNOWFLAKE_PROFILE    Snowflake connection profile (required)
  SNOWFLAKE_WAREHOUSE  Override default warehouse
  SNOWFLAKE_DATABASE   Override default database
  SNOWFLAKE_SCHEMA     Override default schema
  SNOWFLAKE_ROLE       Override default role

Examples:
  # Start server with profile
  SNOWFLAKE_PROFILE=prod nanuk-mcp

  # Start with overrides
  SNOWFLAKE_PROFILE=prod SNOWFLAKE_WAREHOUSE=COMPUTE_WH nanuk-mcp

For more information: https://github.com/Evan-Kim2028/nanuk-mcp
        """,
    )

    parser.add_argument(
        "--profile",
        "-p",
        help="Snowflake profile name (or use SNOWFLAKE_PROFILE env var)",
    )

    parser.add_argument(
        "--verbose",
        "-v",
        action="store_true",
        help="Enable verbose logging",
    )

    parser.add_argument(
        "--version",
        action="version",
        version=f"nanuk-mcp {__import__('nanuk_mcp').__version__}",
    )

    return parser.parse_args()


async def main() -> int:
    """Main entrypoint for MCP server."""
    args = parse_args()

    # Setup logging
    log_level = logging.DEBUG if args.verbose else logging.INFO
    logging.basicConfig(
        level=log_level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )

    # Setup error handling
    setup_error_handling()

    # Get profile from args or environment
    profile = args.profile or os.getenv("SNOWFLAKE_PROFILE")

    if not profile:
        logger.error("No Snowflake profile specified")
        print("Error: SNOWFLAKE_PROFILE environment variable required", file=sys.stderr)
        print("", file=sys.stderr)
        print("Available profiles:", file=sys.stderr)
        for p in get_available_profiles():
            print(f"  - {p}", file=sys.stderr)
        print("", file=sys.stderr)
        print("Usage: SNOWFLAKE_PROFILE=prod nanuk-mcp", file=sys.stderr)
        return 1

    try:
        # Load configuration
        config = load_config(cli_overrides={"profile": profile})
        logger.info(f"Loaded configuration for profile: {profile}")

        # Create MCP server
        server = Server("nanuk-mcp")

        # Register all MCP tools
        # (Tool registration code continues...)

        logger.info("✓ Nanuk MCP server started successfully")
        logger.info("✓ Listening on stdio for MCP requests")

        # Run server
        async with stdio_server() as (read_stream, write_stream):
            await server.run(
                read_stream,
                write_stream,
                server.create_initialization_options(),
            )

        return 0

    except Exception as e:
        logger.exception("Failed to start MCP server")
        print(f"Error: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(asyncio.run(main()))
```

#### 3. pyproject.toml (Complete)

See Phase 2, Step 2 for full pyproject.toml.

#### 4. tests/ Structure

```bash
tests/
├── __init__.py
├── conftest.py                  # Shared fixtures
│
├── unit/                        # Unit tests (services, utilities)
│   ├── test_query_service.py
│   ├── test_catalog_service.py
│   ├── test_lineage_service.py
│   ├── test_dependency_service.py
│   ├── test_config.py
│   ├── test_profile_utils.py
│   └── test_sql_validation.py
│
├── integration/                 # Integration tests (MCP tools)
│   ├── test_mcp_server.py
│   ├── test_execute_query_tool.py
│   ├── test_build_catalog_tool.py
│   ├── test_query_lineage_tool.py
│   └── test_all_tools.py
│
├── performance/                 # Performance benchmarks
│   ├── test_query_performance.py
│   └── test_catalog_performance.py
│
└── fixtures/                    # Test data
    ├── sample_catalog.json
    ├── sample_lineage.json
    └── test_config.yaml
```

---

## Part 6: Package Restructure

### Before (Current v2.0.0 with CLI)

```
src/nanuk_mcp/
├── cli.py                       # 138 LOC - DELETE
├── commands/                    # 1,769 LOC - DELETE
├── mcp_server.py                # 780 LOC - KEEP
├── mcp/tools/                   # ~500 LOC - KEEP
├── services/                    # Keep but simplify
├── catalog/                     # KEEP
├── dependency/                  # KEEP
├── lineage/                     # KEEP
├── config.py                    # Move to core/
├── profile_utils.py             # Move to core/
├── session_utils.py             # Move to core/
├── error_handling.py            # Move to core/
├── sql_validation.py            # Move to core/
└── ... (other modules)
```

### After (v2.0 Pure MCP)

```
src/nanuk_mcp/
├── __init__.py                  # Public API exports
├── mcp_server.py                # MCP server entrypoint (MAIN)
│
├── mcp/                          # MCP implementation
│   ├── __init__.py
│   ├── tools/                    # 12 MCP tools
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── execute_query.py
│   │   ├── preview_table.py
│   │   ├── build_catalog.py
│   │   ├── query_lineage.py
│   │   ├── build_dependency_graph.py
│   │   ├── parallel_query.py
│   │   ├── export_ddl.py
│   │   ├── health_check.py
│   │   ├── test_connection.py
│   │   ├── get_config.py
│   │   └── validate_sql.py
│   └── utils.py
│
├── services/                     # Business logic
│   ├── __init__.py
│   ├── query.py
│   ├── catalog.py
│   ├── lineage.py
│   └── dependency.py
│
├── catalog/                      # Catalog domain
│   ├── __init__.py
│   ├── service.py
│   ├── models.py
│   └── incremental.py
│
├── dependency/                   # Dependency domain
│   ├── __init__.py
│   ├── service.py
│   └── models.py
│
├── lineage/                      # Lineage domain
│   ├── __init__.py
│   ├── queries.py
│   ├── builder.py
│   ├── graph.py
│   ├── traversal.py
│   ├── sql_parser.py
│   ├── models.py
│   └── ... (other modules)
│
├── core/                         # Core infrastructure (NEW)
│   ├── __init__.py
│   ├── config.py
│   ├── profile_utils.py
│   ├── session_utils.py
│   ├── error_handling.py
│   ├── sql_validation.py
│   └── circuit_breaker.py
│
└── models/                       # Shared models
    ├── __init__.py
    └── ... (Pydantic models)
```

**Key Changes:**
1. ✅ `/commands` directory completely removed
2. ✅ `cli.py` removed
3. ✅ Core modules consolidated in `/core`
4. ✅ MCP tools are now primary interface
5. ✅ Cleaner, flatter structure

---

## Part 7: Migration Strategy

### For Existing Users

#### MCP Users (95% of users) - Easy Migration

**Step 1: Package Update**
```bash
pip uninstall snowcli-tools
pip install nanuk-mcp
```

**Step 2: Update Imports**
```python
# Find and replace in your code:
snowcli_tools → nanuk_mcp
```

**Step 3: Update MCP Config**
```json
// .mcp.json
{
  "mcpServers": {
    "nanuk": {
      "command": "nanuk-mcp",  // Changed from "python -m snowcli_tools.mcp_server"
      "env": {
        "SNOWFLAKE_PROFILE": "prod"
      }
    }
  }
}
```

**Total time: 5 minutes**

#### CLI Users (5% of users) - Decision Required

**Option 1: Stay on snowcli-tools v1.x**
```bash
# Keep using v1.x with CLI support
pip install "snowcli-tools>=1.9.0,<2.0.0"
```

**Support:**
- Bug fixes: 12 months (until Oct 2026)
- Security updates: Indefinite
- New features: None (v2.0+ only)

**Option 2: Migrate to MCP**
```bash
# Switch to AI assistant usage
pip install nanuk-mcp

# Configure Claude Code, Cursor, or VS Code
# See docs/migration-from-v1.md
```

**Benefits:**
- Access to v2.0+ features
- Natural language interface
- Better integration with AI workflows
- Actively developed

### Communication Plan

#### Week 1 (Planning)
- ✅ Finalize migration guide
- ✅ Prepare announcement
- ✅ Update documentation

#### Week 2 (Soft Launch)
- 📢 GitHub Discussions post: "v2.0 Pure MCP Coming"
- 📢 Update README with notice
- 📢 Tag v2.0.0-beta.1

#### Week 3 (Beta Testing)
- 📢 Email beta testers (if list available)
- 📢 Solicit feedback on GitHub
- 🐛 Fix issues

#### Week 4 (Official Release)
- 🚀 Release v2.0.0
- 📢 Blog post: "Nanuk MCP v2.0 - Pure MCP Server"
- 📢 Update PyPI description
- 📢 Social media announcement

#### Ongoing
- 📖 Monitor GitHub Issues
- 💬 Answer questions in Discussions
- 🐛 Release patch versions as needed

---

## Part 8: Timeline

### 5-6 Week Aggressive Schedule

```
Week 1: Preparation & Analysis
├─ Day 1-2: MCP feature parity audit
├─ Day 3: Create v1.x LTS branch
├─ Day 4-5: Document breaking changes
└─ Day 5: Finalize migration guide

Week 2: Code Deletion
├─ Day 1: Delete CLI code (~2,000 LOC)
├─ Day 2: Update pyproject.toml
├─ Day 3-4: Fix imports & dependencies
└─ Day 5: Initial testing

Week 3: Cleanup & Refactor
├─ Day 1-2: Package restructure (move to core/)
├─ Day 3: Simplify service layer
├─ Day 4: Update all imports
└─ Day 5: Run full test suite

Week 4: Documentation
├─ Day 1: Rewrite README
├─ Day 2: Create migration guide
├─ Day 3-4: Update all docs
└─ Day 5: Remove CLI references

Week 5: Testing & QA
├─ Day 1-2: Update test suite
├─ Day 3: Coverage testing (target >90%)
├─ Day 4: Performance testing
└─ Day 5: Integration testing

Week 6: Release
├─ Day 1-2: Beta release (v2.0.0-beta.1)
├─ Day 3: Beta testing & feedback
├─ Day 4: Final fixes
└─ Day 5: Official v2.0.0 release 🎉
```

### Key Milestones

- **Week 1 End**: Migration guide ready, v1.x branch created
- **Week 2 End**: All CLI code deleted, imports fixed
- **Week 3 End**: Package restructured, tests passing
- **Week 4 End**: Documentation complete
- **Week 5 End**: >90% test coverage, all tests passing
- **Week 6 End**: v2.0.0 released 🚀

---

## Part 9: Risk Management

### Risks & Mitigation

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| **CLI users revolt** | High | Low | Clear communication, keep v1.x supported, easy migration path |
| **Broken imports after rename** | Medium | Medium | Comprehensive testing, automated import checks, clear error messages |
| **MCP feature gaps** | High | Low | Complete parity audit before deletion, beta testing |
| **Test coverage drops** | Medium | Medium | Strict >90% coverage requirement, no merge without tests |
| **Performance regression** | Medium | Low | Performance benchmarks, continuous monitoring |
| **Documentation outdated** | Low | High | Systematic doc review, automated CLI reference removal |

### Rollback Plan

If v2.0 launch fails catastrophically:

1. **Immediate Rollback**
   ```bash
   # Revert to v1.x
   git revert <v2.0-commit>
   git push

   # Release v1.9.1 as stable
   git tag v1.9.1
   git push --tags
   ```

2. **Communication**
   - Announce rollback on GitHub
   - Notify users to stay on v1.x
   - Investigate issues

3. **Fix Forward**
   - Address issues in feature branch
   - Beta test again
   - Re-release v2.0 when ready

### Support Strategy

**v1.x (snowcli-tools) Support:**
- Maintain separate PyPI package: `snowcli-tools`
- Bug fixes: 12 months
- Security updates: Indefinite
- Branch: `v1.x-lts`

**v2.0 (nanuk-mcp) Support:**
- Active development
- New features only in v2.x
- Backward compatibility not required (breaking changes OK)

---

## Part 10: Success Metrics

### Code Metrics

- **LOC Reduction**: Target 2,000+ LOC deleted (28% reduction)
  - Before: ~7,300 LOC
  - After: ~5,300 LOC
  - Achieved: _____ LOC (to be measured)

- **Dependency Reduction**: Remove 2 core dependencies
  - Before: click, rich, mcp, fastmcp, ...
  - After: mcp, fastmcp, ... (click & rich removed)

- **Package Size**: Target 20% reduction
  - Before: _____ MB (to be measured)
  - After: _____ MB (to be measured)

### Quality Metrics

- **Test Coverage**: Maintain >90%
  - Before: 87%
  - Target: >90%
  - Achieved: _____ % (to be measured)

- **Test Count**: Maintain or increase
  - Before: _____ tests
  - After: _____ tests (remove CLI tests, add MCP integration tests)

- **Performance**: No regression
  - Query execution: <500ms baseline
  - Catalog build: <10s for small DB
  - MCP server startup: <2s

### Adoption Metrics

- **PyPI Downloads** (30 days post-release)
  - nanuk-mcp: Target 1,000+ downloads
  - snowcli-tools v1.x: Monitor for comparison

- **GitHub Metrics**
  - Stars: Monitor growth
  - Issues: Target <10 critical bugs in first month
  - Discussions: Monitor migration questions

- **User Satisfaction**
  - Migration guide rated helpful: >80%
  - Would recommend v2.0: >70%
  - (via GitHub Discussions survey)

### Success Criteria

v2.0.0 launch is **successful** if:

1. ✅ All CLI code removed (~2,000 LOC)
2. ✅ Test coverage maintained >90%
3. ✅ Zero critical bugs in first week
4. ✅ <20 migration-related issues in first month
5. ✅ Performance maintained or improved
6. ✅ Documentation rated helpful by >80% of users
7. ✅ MCP adoption >70% within 3 months

v2.0.0 launch **needs revision** if:

1. ❌ >10 critical bugs in first week
2. ❌ Test coverage drops below 85%
3. ❌ Major performance regression (>50% slower)
4. ❌ >50% of users report migration issues
5. ❌ MCP server fails to start for >20% of users

---

## Part 11: Detailed LOC Analysis

### Current Codebase Breakdown (Estimated)

```bash
# Total: ~7,300 LOC

src/nanuk_mcp/
├── cli.py                         138 LOC   # DELETE
├── commands/                    1,769 LOC   # DELETE
│   ├── __init__.py                202 LOC
│   ├── analyze.py                 540 LOC
│   ├── discover.py                213 LOC
│   ├── query.py                   318 LOC
│   ├── setup.py                   401 LOC
│   ├── registry.py                 68 LOC
│   └── utils.py                    27 LOC
├── mcp_server.py                  780 LOC   # KEEP
├── mcp/                           500 LOC   # KEEP
├── catalog/                       600 LOC   # KEEP
├── dependency/                    400 LOC   # KEEP
├── lineage/                     2,500 LOC   # KEEP
├── services/                      300 LOC   # KEEP (simplify)
├── core modules                   600 LOC   # KEEP (reorganize)
│   ├── config.py
│   ├── profile_utils.py
│   ├── session_utils.py
│   ├── error_handling.py
│   ├── sql_validation.py
│   └── circuit_breaker.py
└── other                          513 LOC   # KEEP

Deletion target: ~1,907 LOC (cli.py + commands/)
Reduction: 26% of codebase
```

### After Deletion (Target)

```bash
# Total: ~5,400 LOC (after deletion & cleanup)

src/nanuk_mcp/
├── mcp_server.py                  800 LOC   # Enhanced
├── mcp/                           650 LOC   # Enhanced (+150)
├── catalog/                       600 LOC
├── dependency/                    400 LOC
├── lineage/                     2,500 LOC
├── services/                      250 LOC   # Simplified (-50)
├── core/                          600 LOC   # Reorganized
└── other                          600 LOC

Total: ~5,400 LOC (-26% reduction)
```

---

## Part 12: Example Code Changes

### Example 1: Service Layer Simplification

#### Before (with CLI logic)

```python
# src/nanuk_mcp/services/query.py (v1.x)

from rich.console import Console
from rich.table import Table

console = Console()

class QueryService:
    """Query service with CLI-specific formatting."""

    def __init__(self, config, output_format='json'):
        self.config = config
        self.output_format = output_format  # 'json' | 'table' | 'csv'

    def execute(self, statement: str) -> dict | None:
        """Execute query and format for CLI output."""
        try:
            result = self._run_query(statement)

            # CLI-specific formatting
            if self.output_format == 'table':
                self._print_table(result)
                return None  # Already printed
            elif self.output_format == 'csv':
                self._print_csv(result)
                return None
            else:
                return result  # JSON for MCP

        except Exception as e:
            # Rich console error (CLI-specific)
            console.print(f"[red]✗[/red] Query failed: {e}")
            raise

    def _print_table(self, result):
        """Print result as rich table."""
        table = Table()
        for col in result['columns']:
            table.add_column(col)
        for row in result['rows']:
            table.add_row(*[str(v) for v in row.values()])
        console.print(table)

    def _print_csv(self, result):
        """Print result as CSV."""
        # CSV formatting logic...
        pass
```

#### After (pure Python)

```python
# src/nanuk_mcp/services/query.py (v2.0)

from pydantic import BaseModel
from typing import Any

class QueryResponse(BaseModel):
    """Structured query response."""
    statement: str
    rowcount: int
    rows: list[dict[str, Any]]
    execution_time_ms: float
    warehouse_used: str
    query_id: str | None = None

class QueryService:
    """Pure Python query service."""

    def __init__(self, config):
        self.config = config

    async def execute(self, statement: str) -> QueryResponse:
        """Execute query and return structured response.

        No formatting logic - let the consumer (MCP tool, programmatic user)
        handle presentation.
        """
        result = await self._run_query(statement)

        return QueryResponse(
            statement=statement,
            rowcount=len(result.rows),
            rows=result.rows,
            execution_time_ms=result.execution_time_ms,
            warehouse_used=result.warehouse,
            query_id=result.query_id,
        )

# MCP tool handles formatting for AI consumption
# Programmatic users get clean Pydantic models
# No CLI-specific logic polluting the service layer
```

### Example 2: Error Handling Transformation

#### Before (CLI-specific errors)

```python
# src/nanuk_mcp/catalog/service.py (v1.x)

from rich.console import Console

console = Console()

class CatalogService:
    def build_catalog(self, database: str) -> dict:
        """Build catalog with CLI error handling."""
        try:
            tables = self._fetch_tables(database)
            console.print(f"[green]✓[/green] Found {len(tables)} tables")

            return {"tables": tables}

        except DatabaseNotFoundError as e:
            console.print(f"[red]✗[/red] Database '{database}' not found")
            console.print("[yellow]💡[/yellow] Hint: Check SHOW DATABASES")
            raise SystemExit(1)

        except PermissionError as e:
            console.print(f"[red]✗[/red] Permission denied")
            console.print("[yellow]💡[/yellow] Hint: Grant USAGE on database")
            raise SystemExit(1)
```

#### After (structured errors for AI)

```python
# src/nanuk_mcp/catalog/service.py (v2.0)

from pydantic import BaseModel

class CatalogError(Exception):
    """Base catalog error with structured info."""
    def __init__(self, message: str, error_code: str, hints: list[str]):
        self.message = message
        self.error_code = error_code
        self.hints = hints
        super().__init__(message)

    def to_dict(self) -> dict:
        """Convert to structured dict for AI consumption."""
        return {
            "error": self.error_code,
            "message": self.message,
            "hints": self.hints,
        }

class CatalogService:
    async def build_catalog(self, database: str) -> dict:
        """Build catalog with structured error handling."""
        try:
            tables = await self._fetch_tables(database)

            return {
                "database": database,
                "tables": tables,
                "status": "success",
            }

        except DatabaseNotFoundError as e:
            raise CatalogError(
                message=f"Database '{database}' not found",
                error_code="DATABASE_NOT_FOUND",
                hints=[
                    "Check available databases with: SHOW DATABASES",
                    "Verify database name spelling",
                    "Check you have USAGE privilege",
                ],
            )

        except PermissionError as e:
            raise CatalogError(
                message=f"Permission denied on database '{database}'",
                error_code="PERMISSION_DENIED",
                hints=[
                    f"Grant USAGE: GRANT USAGE ON DATABASE {database} TO ROLE <your_role>",
                    "Check your current role: SELECT CURRENT_ROLE()",
                    "Contact your Snowflake admin",
                ],
            )

# MCP tool catches CatalogError and returns structured error to AI
# AI can parse the error, present hints to user, suggest fixes
# Much better than CLI "✗" symbols and exit codes
```

---

## Part 13: Pre-Flight Checklist

Before starting Phase 1, verify:

### Repository State
- [ ] Current branch: `main` or `v2.0-dev`
- [ ] All changes committed
- [ ] Working directory clean
- [ ] Tests passing: `pytest tests/`
- [ ] Version: 2.0.0 in pyproject.toml

### Dependencies
- [ ] `uv` installed: `uv --version`
- [ ] Python 3.12+: `python --version`
- [ ] Git configured
- [ ] GitHub access (for pushing branches)

### Documentation
- [ ] Current README reviewed
- [ ] Existing docs inventory complete
- [ ] Migration guide template ready

### Team Alignment
- [ ] Breaking changes approved
- [ ] Timeline agreed upon
- [ ] Communication plan ready
- [ ] Beta testers identified (if any)

---

## Part 14: Post-Launch Monitoring

### Week 1 Post-Launch
- Monitor GitHub Issues (target: <5 critical bugs)
- Track PyPI downloads (compare v1.x vs v2.0)
- Answer migration questions in Discussions
- Release v2.0.1 if critical bugs found

### Week 2-4 Post-Launch
- Collect user feedback via survey
- Monitor test coverage (maintain >90%)
- Track adoption metrics
- Write blog post on migration experience

### Month 2-3
- Evaluate success metrics
- Plan v2.1.0 features (MCP-only enhancements)
- Continue v1.x bug fixes (if needed)
- Build community around MCP usage

---

## Conclusion

This is an **aggressive, execution-ready plan** to transform nanuk-mcp into a pure MCP server by **completely removing CLI code**.

### Why This Works

1. **Already at v2.0**: Breaking changes acceptable
2. **Clean separation**: CLI and MCP already isolated
3. **MCP adoption high**: 95% users already on MCP
4. **Clear benefits**: Simpler codebase, better positioning
5. **Aggressive timeline**: 5-6 weeks, not 6 months

### Key Deliverables

- ✅ 2,000+ LOC deleted (26% reduction)
- ✅ Zero CLI dependencies (click, rich removed)
- ✅ Pure MCP architecture
- ✅ >90% test coverage maintained
- ✅ Comprehensive documentation
- ✅ Clear migration path for all users

### Next Steps

1. **Review this plan** (1-2 days)
2. **Get approval** for aggressive approach
3. **Start Phase 1** (Week 1: Preparation)
4. **Execute rapidly** (Weeks 2-6)
5. **Launch v2.0.0** 🚀

---

**Ready to execute?** Let's rip the bandaid off and build the best pure MCP server for Snowflake! 🐻‍❄️

**Version:** 1.0
**Date:** October 7, 2025
**Status:** EXECUTION READY
**Timeline:** 5-6 weeks aggressive
