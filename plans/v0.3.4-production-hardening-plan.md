# v0.3.4 Release Plan: Production Hardening & Code Quality

## Executive Summary

This release focuses on **production hardening**, **code debt cleanup**, and **developer experience improvements** - preparing igloo-mcp for serious production use. No major new features; instead, we're making the existing codebase more robust, maintainable, and professional.

**Theme**: "Rock Solid Foundation"

---

## Issue Inventory (15 Open Issues)

| # | Title | Category | Priority | Effort |
|---|-------|----------|----------|--------|
| 95 | Refactor tool_error_handler duplication | Code Debt | P1 | Low |
| 96 | Standardize parameter validation | Code Debt | P1 | Medium |
| 97 | Compact error messages by default | UX | P1 | Medium |
| 76 | Add CI/CD workflows | Infrastructure | P1 | Medium |
| 98 | SQL validation strategy pattern | Code Debt | P2 | High |
| 87 | Refactor broad exception handling | Code Debt | P2 | High |
| 81 | Centralize config with pydantic-settings | Architecture | P2 | Medium |
| 80 | Add retry logic with tenacity | Resilience | P2 | Low |
| 72 | Standardize error status values | Consistency | P3 | Low |
| 74 | Chart generation TODO | Tech Debt | P3 | Low |
| 84 | Improve test coverage | Testing | P3 | High |
| 85 | Add CONTRIBUTING.md | Documentation | P3 | Low |
| 86 | Expand AGENTS.md | Documentation | P3 | Low |
| 91 | HTML standalone reports | Feature | Defer | High |
| 62 | Citations field | Feature | Defer | High |

---

## Recommended v0.3.4 Scope

### Tier 1: Must Have (Production Hardening)

These are foundational improvements that make the codebase production-ready:

#### 1. CI/CD Foundation (#76)
**Why**: Without CI, there's no automated quality gate. This is table stakes.
- Create `.github/workflows/ci.yml` (lint, type-check, test)
- Create `.github/workflows/release.yml` (PyPI publish)
- Add codecov integration
- **Effort**: 2-3 hours
- **Risk**: Low

#### 2. Error Handler Deduplication (#95)
**Why**: 200 lines of duplicated code is a maintenance nightmare.
- Extract common error handling to shared helper
- Reduce ~200 lines → ~100 lines
- No behavior change
- **Effort**: 1-2 hours
- **Risk**: Low (pure refactor)

#### 3. Compact Error Messages (#97)
**Why**: Token cost savings + better UX. Currently 200-500 tokens per error.
- Default to 1-2 hints max
- Add `verbose_errors=True` opt-in for full hints
- 60%+ token reduction on errors
- **Effort**: 2-3 hours
- **Risk**: Low (backward compatible if opt-in)

#### 4. Parameter Validation Standardization (#96)
**Why**: Inconsistent validation = inconsistent behavior = bugs.
- Move all validation to `validate_parameters()` method
- Create shared validation helpers
- Add validation unit tests
- **Effort**: 3-4 hours
- **Risk**: Low

### Tier 2: Should Have (Code Quality)

These improve maintainability but aren't blocking production use:

#### 5. Error Status Consistency (#72)
**Why**: Quick win. `"failed"` vs `"error"` is confusing.
- Standardize on `"error"` everywhere
- One-line fix
- **Effort**: 15 minutes
- **Risk**: Very Low

#### 6. Retry Logic with Tenacity (#80)
**Why**: Transient failures shouldn't trigger circuit breaker.
- Add `tenacity` dependency
- Create `with_retry()` decorator
- Apply to Snowflake operations
- **Effort**: 1-2 hours
- **Risk**: Low

#### 7. Chart Generation TODO (#74)
**Why**: Clean up or remove stale TODO.
- Either implement basic chart support OR
- Remove the misleading TODO comment
- **Effort**: 30 min (remove) or 4h (implement)
- **Recommendation**: Remove for v0.3.4, track separately

### Tier 3: Nice to Have (Polish)

Lower priority but valuable:

#### 8. CONTRIBUTING.md (#85)
**Why**: Standard open source hygiene.
- Development setup instructions
- PR process
- Conventional commits
- **Effort**: 30-60 minutes

#### 9. AGENTS.md Expansion (#86)
**Why**: Helps AI assistants work with the codebase.
- Architecture overview
- Key patterns
- Common tasks
- **Effort**: 1-2 hours

### Defer to v0.3.5 or Later

These are significant undertakings that deserve their own release:

#### Deferred: SQL Validation Strategy Pattern (#98)
**Why Defer**: High effort (4-6 hours), needs careful design.
- P2 priority issue says "Target v0.3.4 or later"
- Benefits are real but not urgent
- **Recommendation**: Target for v0.3.5

#### Deferred: Exception Handling Refactor (#87)
**Why Defer**: 50+ locations to review. High effort.
- Important for observability
- Requires careful analysis of each site
- **Recommendation**: Target for v0.3.5

#### Deferred: Pydantic-Settings (#81)
**Why Defer**: Touches 10+ files, needs migration path.
- Good architecture improvement
- But scattered changes = higher risk
- **Recommendation**: Target for v0.3.5

#### Deferred: Test Coverage (#84)
**Why Defer**: Ongoing effort, not a discrete deliverable.
- Continue improving incrementally
- Don't block releases for coverage

#### Deferred: HTML Standalone Reports (#91)
**Why Defer**: Feature, not hardening. 2-3 week effort.
- Great user request
- But doesn't fit "production hardening" theme
- **Recommendation**: Target for v0.4.0

#### Deferred: Citations Field (#62)
**Why Defer**: Breaking change (eventually), needs migration.
- Valuable feature
- Complex migration path
- **Recommendation**: Target for v0.4.0

---

## Proposed v0.3.4 Checklist

### Must Ship
- [ ] #76 - CI/CD workflows (lint, type-check, test, release)
- [ ] #95 - Refactor tool_error_handler deduplication
- [ ] #97 - Compact error messages (default compact, opt-in verbose)
- [ ] #96 - Standardize parameter validation

### Should Ship
- [ ] #72 - Standardize `"error"` status (trivial fix)
- [ ] #80 - Add tenacity retry logic

### Nice to Ship
- [ ] #74 - Remove chart generation TODO (or implement)
- [ ] #85 - Add CONTRIBUTING.md
- [ ] #86 - Expand AGENTS.md

### Explicitly NOT in v0.3.4
- #98 - SQL validation strategy → v0.3.5
- #87 - Exception handling refactor → v0.3.5
- #81 - Pydantic-settings → v0.3.5
- #84 - Test coverage → ongoing
- #91 - HTML standalone → v0.4.0
- #62 - Citations → v0.4.0

---

## Estimated Effort

| Tier | Issues | Est. Hours |
|------|--------|------------|
| Must Have | 4 | 8-12 hours |
| Should Have | 2 | 1.5-2.5 hours |
| Nice to Have | 3 | 2-4 hours |
| **Total** | **9** | **11.5-18.5 hours** |

Realistic timeline: **1-2 focused days** of work.

---

## Success Criteria for v0.3.4

1. **CI/CD active**: PRs blocked if tests/lint fail
2. **Error tokens reduced**: 60%+ reduction in error message tokens
3. **Code reduction**: ~100 lines removed from tool_error_handler
4. **Validation consistent**: All tools use `validate_parameters()`
5. **Retries work**: Transient failures retry before circuit breaker
6. **All existing tests pass**: No regressions

---

## Implementation Order

Recommended sequence to minimize conflicts:

1. **#76 CI/CD** - First, so all subsequent PRs get CI coverage
2. **#72 Error status** - Trivial, quick win
3. **#95 Error handler refactor** - Self-contained refactor
4. **#97 Compact errors** - Depends on #95 being clean
5. **#96 Validation standardization** - Can be parallelized
6. **#80 Tenacity retry** - Independent
7. **#74 Chart TODO** - Quick cleanup
8. **#85 CONTRIBUTING.md** - Independent documentation
9. **#86 AGENTS.md** - Independent documentation

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| CI catches issues we didn't know about | Good! Fix them before release |
| Compact errors break someone's parsing | Keep `verbose_errors` opt-in for compatibility |
| Validation changes break edge cases | Write tests for each tool's validation |
| Retry logic masks real errors | Log all retries, don't retry on validation errors |

---

## Questions to Resolve

1. **Error status**: Standardize on `"error"` everywhere, or keep `"failed"` for health checks specifically?
2. **Compact errors**: Should `verbose_errors` be per-request or server-wide config?
3. **Chart TODO**: Remove it or implement basic support?
4. **CI coverage threshold**: What minimum coverage to enforce (70%? 75%)?

---

## Post-v0.3.4 Roadmap Preview

### v0.3.5 (Code Quality)
- #98 SQL validation strategy pattern
- #87 Exception handling refactor
- #81 Pydantic-settings centralization
- Continued test coverage improvement

### v0.4.0 (Features)
- #91 HTML standalone reports
- #62 Citations field (with migration)
- Chart generation (if not done in v0.3.4)

---

## Summary

v0.3.4 is about **discipline, not features**:
- Automate quality gates (CI/CD)
- Clean up code debt (deduplication, validation)
- Improve UX (compact errors)
- Add resilience (retries)

This sets up a solid foundation for the feature work in v0.4.0.
