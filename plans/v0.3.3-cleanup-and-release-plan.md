# v0.3.3 Cleanup and Release Plan

## Overview
Comprehensive plan to clean up the v0.3.3-prep branch, update documentation, remove dead code, and prepare for production release.

## Phase 1: Fix Critical Issues ‚ö†Ô∏è

### 1.1 Fix Failing Test
**Priority: CRITICAL**

**Issue:** `tests/system/test_user_workflows.py::test_iterative_refinement_workflow`
- Line 285: `assert len(outline.insights) == 1` fails (found 0)
- Root cause: `evolve_report` not persisting insights from `insights_to_add`

**Action:**
```bash
# Investigate why insights aren't being added
# Check evolve_report.py _apply_changes method
# Verify ProposedChanges validation
```

**Files to check:**
- `src/igloo_mcp/mcp/tools/evolve_report.py:813-875` (insight addition logic)
- `src/igloo_mcp/living_reports/changes_schema.py` (validation)
- `tests/system/test_user_workflows.py:262-281` (test setup)

### 1.2 Resolve MyPy Type Errors
**Priority: HIGH**

**Issues:**
1. `mcp_server.py:30` - Duplicate NotFoundError import
2. `mcp_server.py:235` - Middleware type mismatch

**Action:**
```python
# Fix line 30 - adjust type ignore
from mcp.server.fastmcp.exceptions import NotFoundError  # type: ignore[import-untyped,assignment,no-redef]

# Fix line 235 - add explicit type annotation
middleware_stack[i] = conditional_sql_validation_middleware  # type: ignore[assignment]
```

## Phase 2: Dead Code Removal üßπ

### 2.1 Version Updates
**Files to update:**

1. `src/igloo_mcp/__init__.py:8`
   ```python
   __version__ = "0.3.0"  # Update to "0.3.3"
   ```

2. `pyproject.toml` (check current version)

### 2.2 Commented-Out Code
**Files to review:**

1. `src/igloo_mcp/mcp/tools/__init__.py:30-32,49-50`
   - Remove commented lineage tool references (already documented as removed)

2. `src/igloo_mcp/mcp_server.py:52-94`
   - Remove commented "QueryHistory and update_cache_manifest_insight" reference (line 91-92)
   - Remove commented "SnowCLI no longer used" reference (line 94)

### 2.3 Unused Imports
**Action:** Run automated check
```bash
# Use ruff to find unused imports
uv run ruff check src/ --select F401 --fix
```

## Phase 3: Documentation Updates üìö

### 3.1 Core Documentation

**README.md**
- ‚úÖ Already updated with v0.3.3 API Completeness section (line 24)
- No changes needed

**CHANGELOG.md**
- ‚úÖ Already has v0.3.3 section (lines 6-30)
- Verify completeness after fixing tests

### 3.2 API Documentation

**Files needing v0.3.3 updates:**

1. **docs/api/ERROR_HANDLING.md**
   - ‚úÖ Already documents request_id (lines 64-76)
   - ‚úÖ Already documents timing (lines 78-90)
   - No changes needed

2. **docs/api/tools/build_catalog.md**
   - ‚úÖ Documents request_id parameter (line 50)
   - ‚úÖ Documents timing response (lines 86-89)
   - ‚úÖ Documents warnings (line 90-101)
   - No changes needed

3. **docs/api/tools/get_catalog_summary.md**
   - ‚úÖ Documents request_id and timing (lines 89-90)
   - No changes needed

4. **docs/api/tools/search_catalog.md**
   - ‚úÖ Documents request_id, timing, warnings (lines 59-63)
   - No changes needed

5. **docs/api/tools/health_check.md**
   - ‚úÖ Documents request_id and timing (lines 75-76)
   - No changes needed

6. **docs/api/tools/create_report.md**
   - ‚úÖ Documents section_ids_added, insight_ids_added (lines 82-94)
   - No changes needed

7. **docs/api/tools/evolve_report.md**
   - ‚úÖ Documents response_detail, timing (lines 192-310)
   - ‚úÖ Documents section_ids_removed, insight_ids_removed (lines 252-256)
   - No changes needed

8. **docs/api/tools/render_report.md**
   - ‚úÖ Documents request_id (line 338)
   - No changes needed

**Conclusion:** All documentation is already up-to-date for v0.3.3!

### 3.3 Missing Documentation

**Action:** Verify all tools have complete docs
```bash
# Check for any undocumented tools
ls docs/api/tools/*.md
```

Expected tools:
- ‚úÖ build_catalog.md
- ‚úÖ create_report.md
- ‚úÖ evolve_report.md
- ‚úÖ get_catalog_summary.md
- ‚úÖ health_check.md
- ‚úÖ render_report.md
- ‚úÖ search_catalog.md
- Need to verify: build_dependency_graph.md, execute_query.md, get_report.md, get_report_schema.md, search_report.md, test_connection.md

## Phase 4: Cleanup Temp Files üóëÔ∏è

### 4.1 Uncommitted Changes

**Files to commit:**
- `src/igloo_mcp/mcp/tools/evolve_report.py` (response symmetry fields)
- `src/igloo_mcp/mcp_server.py` (if changes are legitimate)
- `tests/test_api_completeness_request_id_timing.py` (health check mocking)

**Files to delete:**
```bash
git clean -n  # Preview
# Then remove:
rm .env.grok .env.morph
rm -rf .grok/
rm API_RESPONSE_BEST_PRACTICES.md MORPH_MCP_SETUP.md
rm grok_cli_readme.md morph_llm_docs.txt mypy_errors.txt
rm -rf plans/  # If not needed for release
```

### 4.2 Git Ignore Updates

**Action:** Ensure .gitignore covers:
```
.env.*
.grok/
mypy_errors.txt
*_docs.txt
```

## Phase 5: Final Verification ‚úÖ

### 5.1 Test Suite
```bash
# Run all tests
uv run pytest

# Run specific failing test
uv run pytest tests/system/test_user_workflows.py::test_iterative_refinement_workflow -v

# Check test coverage
uv run pytest --cov=src --cov-report=term-missing
```

### 5.2 Type Checking
```bash
# Full type check
uv run mypy src/

# Check specific files
uv run mypy src/igloo_mcp/mcp_server.py
```

### 5.3 Linting
```bash
# Run ruff
uv run ruff check src/

# Auto-fix
uv run ruff check src/ --fix
```

### 5.4 Build Test
```bash
# Verify package builds
uv build

# Test installation
uv pip install -e .
```

## Phase 6: Release Checklist üöÄ

### 6.1 Pre-Release
- [ ] All tests passing (702/702)
- [ ] No MyPy errors
- [ ] No ruff warnings
- [ ] Documentation complete and accurate
- [ ] Version updated to 0.3.3
- [ ] CHANGELOG.md complete
- [ ] Temp files removed
- [ ] Clean git status

### 6.2 Commit Strategy
```bash
# Commit fixes separately
git add src/igloo_mcp/mcp/tools/evolve_report.py
git commit -m "fix(evolve_report): add response symmetry fields for v0.3.3"

git add src/igloo_mcp/mcp_server.py
git commit -m "fix(types): resolve MyPy type errors in middleware and imports"

git add tests/test_api_completeness_request_id_timing.py
git commit -m "test(api): improve health check mocking for optional parameters"

git add src/igloo_mcp/__init__.py
git commit -m "chore: bump version to 0.3.3"
```

### 6.3 Final Merge
```bash
# Merge to main
git checkout main
git merge v0.3.3-prep

# Tag release
git tag v0.3.3
git push origin main --tags
```

## Success Criteria

‚úÖ **Code Quality**
- All 702 tests passing
- Zero MyPy errors
- Zero ruff warnings
- Clean git status (no uncommitted changes)

‚úÖ **Documentation**
- All tools documented
- API completeness features documented
- CHANGELOG.md updated
- README.md accurate

‚úÖ **Functionality**
- All v0.3.3 features working
  - request_id tracking
  - timing metrics
  - warnings infrastructure
  - response symmetry (IDs tracking)

## Timeline

**Phase 1-2:** 2-4 hours (fix critical issues, remove dead code)
**Phase 3:** 1 hour (verify documentation)
**Phase 4:** 30 minutes (cleanup temp files)
**Phase 5:** 1 hour (final verification)
**Phase 6:** 30 minutes (release)

**Total:** ~5-7 hours for complete cleanup and release
