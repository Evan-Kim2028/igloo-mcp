# feat: Release v0.3.3 - API Completeness and Critical Fixes

## Overview

This release consolidates two major improvement branches to deliver enhanced API response metadata, improved type safety, better validation, and cleaner tooling configuration.

**Target Version:** 0.3.3
**Current Version:** 0.3.2
**PRs to Merge:**
- PR #93: `api-completeness-batch` - API response metadata and traceability
- PR #92: `v0.3.3` - Config, type safety, validation, and docs fixes

## Problem Statement

The v0.3.2 release identified several gaps in the MCP API responses and codebase quality:

1. **Missing API Metadata** - No request_id for distributed tracing, no timing metrics, incomplete ID tracking for created/removed entities
2. **Type Safety Issues** - 18 MyPy errors in `changes_schema.py`, confusing validation error messages
3. **Configuration Problems** - Invalid TOML section, redundant pre-commit hooks, missing `.env.example`
4. **Documentation Gaps** - Incorrect examples in `get_report_schema.py`

## Proposed Solution

Merge both feature branches into main and release as v0.3.3.

### Branch 1: API Completeness (PR #93)

**Issues Closed:** #67, #68, #69, #70, #71, #73

| Feature | Files Changed | Description |
|---------|--------------|-------------|
| `request_id` | 4 tools | UUID4 for distributed tracing |
| `timing` metrics | 4 tools | Performance monitoring |
| `warnings` infra | 3 tools | Non-fatal issue reporting |
| ID tracking | 3 tools | Response symmetry for created/removed entities |

**Files:**
- `src/igloo_mcp/mcp/tools/build_catalog.py`
- `src/igloo_mcp/mcp/tools/get_catalog_summary.py`
- `src/igloo_mcp/mcp/tools/search_catalog.py`
- `src/igloo_mcp/mcp/tools/health.py`
- `src/igloo_mcp/mcp/tools/evolve_report.py`
- `src/igloo_mcp/mcp/tools/create_report.py`
- `src/igloo_mcp/living_reports/service.py`

**Tests Added:** 57 tests across 4 files
- `tests/test_api_completeness_request_id_timing.py` (11 tests)
- `tests/test_api_completeness_id_tracking.py` (13 tests)
- `tests/test_api_completeness_warnings.py` (12 tests)
- `tests/test_api_completeness_integration.py` (21 tests)

### Branch 2: Critical Fixes (PR #92)

**Issues Closed:** #65, #66, #75, #77, #78, #79, #82, #83, #88, #89

**Batch A: Config/Tooling**
| Issue | Fix |
|-------|-----|
| #78 | Remove invalid `[tool.uv.build]` section |
| #79 | Simplify pre-commit to use only ruff |
| #82 | Add comprehensive `.env.example` |
| #83 | Fix 6 line-too-long + 3 lambda assignment errors |

**Batch B: Type Safety & Validation**
| Issue | Fix |
|-------|-----|
| #77 | Fix 18 MyPy errors in `changes_schema.py` |
| #66 | Improve validation error messages with hints |
| #75 | SQL validation raises `ValueError` not `AttributeError` |

**Batch C: Documentation**
| Issue | Fix |
|-------|-----|
| #65 | Correct `get_report_schema` examples |

**Batch D: Living Reports Bugs**
| Issue | Fix |
|-------|-----|
| #88 | Apply `title_change` and `metadata_updates` in evolve |
| #89 | Universal citation enforcement (all templates) |

**Tests Added:**
- `tests/test_regression_v033.py` (9 tests for citation and metadata)

## Acceptance Criteria

- [ ] PR #92 merged to main
- [ ] PR #93 merged to main (handle any conflicts)
- [ ] Version bumped to 0.3.3 in `pyproject.toml`
- [ ] All tests pass (`uv run pytest`)
- [ ] Type checking passes (`uv run mypy`)
- [ ] Linting passes (`uv run ruff check`)
- [ ] Git tag v0.3.3 created
- [ ] Release notes generated

## Technical Approach

### Phase 1: Merge PR #92 First

PR #92 (`v0.3.3` branch) is the base with config fixes. Merge this first since it:
- Fixes tooling issues that affect development workflow
- Has cleaner `pyproject.toml` and pre-commit config
- Contains the base version bump groundwork

```bash
gh pr merge 92 --merge
git fetch origin
git checkout main
git pull
```

### Phase 2: Merge PR #93 (Handle Conflicts)

PR #93 (`api-completeness-batch`) may have conflicts in shared files:
- `src/igloo_mcp/mcp/tools/create_report.py`
- `src/igloo_mcp/mcp/tools/evolve_report.py`
- `src/igloo_mcp/mcp/tools/search_catalog.py`

```bash
gh pr merge 93 --merge
# OR if conflicts:
git checkout api-completeness-batch
git rebase main
# Resolve conflicts in affected files
git push --force-with-lease
gh pr merge 93 --merge
```

### Phase 3: Version Bump & Release

```bash
# Update version
sed -i '' 's/version = "0.3.2"/version = "0.3.3"/' pyproject.toml

# Verify
uv run pytest
uv run mypy src/
uv run ruff check src/

# Tag and release
git add pyproject.toml
git commit -m "chore: bump version to 0.3.3"
git tag v0.3.3
git push origin main --tags
```

## Conflict Resolution Strategy

**Expected Conflicts in `create_report.py`:**
- PR #92 has line-length fixes (formatting)
- PR #93 adds timing and ID tracking

Resolution: Keep PR #93's content (functional changes), ensure formatting compliance.

**Expected Conflicts in `evolve_report.py`:**
- PR #92 has citation enforcement and metadata updates
- PR #93 adds `section_ids_removed` and `insight_ids_removed`

Resolution: Merge both sets of changes - they affect different parts of the response.

**Expected Conflicts in `search_catalog.py`:**
- PR #92 has line-length fixes
- PR #93 adds request_id, timing, warnings

Resolution: Keep PR #93's content, ensure lines stay under 120 chars.

## Release Notes (Draft)

```markdown
## v0.3.3 - API Completeness and Critical Fixes

### API Enhancements
- **Distributed Tracing**: Added `request_id` (UUID4) to catalog and health tools
- **Performance Monitoring**: Added `timing` metrics with duration breakdowns
- **Warnings Infrastructure**: Structured warnings field for non-fatal issues
- **Response Symmetry**: Added `*_ids_removed` and `*_ids_added` for complete audit

### Bug Fixes
- Fixed 18 MyPy type errors in changes_schema.py
- SQL validation now raises `ValueError` instead of `AttributeError`
- Universal citation enforcement (all templates, not just analyst_v1)
- `title_change` and `metadata_updates` now properly applied in evolve

### Developer Experience
- Simplified pre-commit config (ruff only)
- Added comprehensive `.env.example`
- Fixed all ruff linting warnings
- Corrected `get_report_schema` examples

### Issues Closed
#65, #66, #67, #68, #69, #70, #71, #73, #75, #77, #78, #79, #82, #83, #88, #89
```

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Merge conflicts | Medium | Detailed conflict resolution strategy above |
| Breaking changes | Low | All API changes are additive |
| Test failures post-merge | Medium | Run full test suite after each merge |
| Citation enforcement regression | Medium | Regression tests in `test_regression_v033.py` |

## Dependencies

- PR #92 and PR #93 must both be approved/ready
- No external dependencies
- No database migrations required

## References

### PRs
- PR #93: https://github.com/Evan-Kim2028/igloo-mcp/pull/93
- PR #92: https://github.com/Evan-Kim2028/igloo-mcp/pull/92

### Related Issues (Closed by this release)
- #65: Correct get_report_schema examples
- #66: Improve validation error messages
- #67: evolve_report response symmetry
- #68: Audit trail section_ids_removed
- #69: create_report ID tracking
- #70: get_catalog_summary request_id/timing
- #71: build_catalog request_id/timing
- #73: Warnings infrastructure
- #75: SQL validation ValueError
- #77: MyPy type errors
- #78: Invalid pyproject.toml section
- #79: Simplify pre-commit
- #82: Add .env.example
- #83: Ruff linting fixes
- #88: metadata_updates not applied
- #89: Citation enforcement
